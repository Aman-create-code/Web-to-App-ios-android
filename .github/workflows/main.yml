name: Shadowchat Pro Multi-Build
on:
  repository_dispatch:
    types: [nexus_build_trigger]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node & Java
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Install Tools
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android @capacitor/ios
          mkdir -p www && echo "<html></html>" > www/index.html

      - name: Sanitize & Configure
        run: |
          # BEREINIGUNG: Entfernt Bindestriche aus der App-ID für Java-Konformität
          RAW_ID="${{ github.event.client_payload.id }}"
          CLEAN_ID=$(echo $RAW_ID | sed 's/-//g')
          APP_NAME="${{ github.event.client_payload.name }}"
          
          echo "Using App ID: $CLEAN_ID"
          echo "Using App Name: $APP_NAME"

          # Initialisierung mit der sauberen ID
          npx cap init "$APP_NAME" "$CLEAN_ID" --web-dir www
          
          # URL Injektion
          sed -i "" "s|PLACEHOLDER_URL|${{ github.event.client_payload.url }}|g" capacitor.config.json
          
          npx cap add android
          npx cap add ios

      - name: Android Build
        run: |
          npx cap copy android
          cd android && chmod +x gradlew && ./gradlew assembleDebug

      - name: iOS Project Preparation
        run: |
          npx cap copy ios
          zip -r iOS-Project.zip ios/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.name }}-Builds
          path: |
            android/app/build/outputs/apk/debug/app-debug.apk
            iOS-Project.zip
