name: Multi-Platform Build
on:
  repository_dispatch:
    types: [nexus_build_trigger]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Install Dependencies
        run: npm install

      - name: Inject Website URL
        run: |
          # Hier passiert die Magie: Die URL von der Website ersetzt den Platzhalter
          sed -i "" "s|PLACEHOLDER_URL|${{ github.event.client_payload.url }}|g" capacitor.config.json
          # Name anpassen
          sed -i "" "s/Shadowchat/${{ github.event.client_payload.name }}/g" capacitor.config.json

      - name: Initialize Platforms
        run: |
          mkdir -p www && echo " " > www/index.html
          npx cap add android
          npx cap add ios

      - name: Android Build
        run: |
          npx cap copy android
          cd android && chmod +x gradlew && ./gradlew assembleDebug

      - name: iOS Build
        run: |
          npx cap copy ios
          zip -r iOS-Project.zip ios/

      - name: Upload APK & iOS Project
        uses: actions/upload-artifact@v4
        with:
          name: App-Files
          path: |
            android/app/build/outputs/apk/debug/app-debug.apk
            iOS-Project.zip
